<!DOCTYPE html>
<meta charset="utf-8">

<!-- Import D3.js -->
<script src="https://d3js.org/d3.v6.min.js"></script>

<body>
<!-- Add speed control buttons -->
<button onclick="setDelay(1000)">Slow</button>
<button onclick="setDelay(500)">Medium</button>
<button onclick="setDelay(20)">Fast</button>

<script>
// Set the dimensions and margins of the graph
var margin = {top: 10, right: 30, bottom: 30, left: 40},
    width = 800 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

// Append the SVG object to the body of the page
var svg = d3.select("body")
  .append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

// Locations of the regions
var foci = {
    "APAC": {x: width/3, y: height/2},
    "EMEA": {x: width/2, y: height/2},
    "AMER": {x: 2*width/3, y: height/2}
};

// Colors of the regions
var colors = {
    "APAC": "lightgrey",
    "EMEA": "red",
    "AMER": "darkgrey"
};

// Load the data
d3.json("data.js").then(function(data) {
    // Create a node for each city
    var nodes = Array.from(new Set(data.map(function(d) { return d["Requested By Location"]; })))
        .map(function(city, i) {
            var angle = (i / data.length) * 2 * Math.PI;
            var edgeX = width / 2 + (width / 2 - 50) * Math.cos(angle);
            var edgeY = height / 2 + (height / 2 - 50) * Math.sin(angle);
            return {
                id: i,
                city: city,
                x: edgeX,
                y: edgeY
            };
        });

    // Create SVG circles for each city
    var cityCircles = svg.selectAll(".city")
        .data(nodes)
        .enter()
        .append("circle")
        .classed("city", true)
        .attr("r", 5) // Radius of the bubbles
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; })
        .attr("fill", "black");

    // Create SVG text for each city
    var cityLabels = svg.selectAll(".city-label")
        .data(nodes)
        .enter()
        .append("text")
        .classed("city-label", true)
        .style("font-size", "16px") // Increase font size
        .attr("dx", function(d) { return d.x; })
        .attr("dy", function(d) { return d.y - 10; }) // Offset the labels above the bubbles
        .text(function(d) { return d.city; });

    // Create SVG text for each region
    var regionLabels = svg.selectAll(".region-label")
        .data(Object.keys(foci))
        .enter()
        .append("text")
        .classed("region-label", true)
        .attr("dx", function(d) { return foci[d].x; })
        .attr("dy", function(d) { return foci[d].y - 20; }) // Offset the labels above the bubbles
        .text(function(d) { return d; });

    // Create a force simulation
    var simulation = d3.forceSimulation()
        .force("x", d3.forceX(function(d) { return foci[d.region].x; }).strength(0.05))
        .force("y", d3.forceY(function(d) { return foci[d.region].y; }).strength(0.05))
        .force("collide", d3.forceCollide(10));

    // Animation for each request
    var i = 0;
    var interval = setInterval(function() {
        if (i >= data.length) {
            clearInterval(interval);
            return;
        }
        var record = data[i];
        var node = nodes.find(function(d) { return d.city === record["Requested By Location"]; });
        var request = svg.append("circle")
            .classed("request", true)
            .attr("r", 3)
            .attr("cx", node.x)
            .attr("cy", node.y)
            .attr("fill", colors[record["Assigned to Region"]]);
        node.region = record["Assigned to Region"];
        simulation.nodes([node]);
        simulation.alpha(1).restart();
        simulation.on("tick", function() {
            request.attr("cx", node.x).attr("cy", node.y);
        });
        i++;
    }, 1000);
});

function setDelay(delay) {
    clearInterval(interval);
    interval = setInterval(function() {
        if (i >= data.length) {
            clearInterval(interval);
            return;
        }
        var record = data[i];
        var node = nodes.find(function(d) { return d.city === record["Requested By Location"]; });
        var request = svg.append("circle")
            .classed("request", true)
            .attr("r", 3)
            .attr("cx", node.x)
            .attr("cy", node.y)
            .attr("fill", colors[record["Assigned to Region"]]);
        node.region = record["Assigned to Region"];
        simulation.nodes([node]);
        simulation.alpha(1).restart();
        simulation.on("tick", function() {
            request.attr("cx", node.x).attr("cy", node.y);
        });
        i++;
    }, delay);
}
</script>
</body>
</html>
